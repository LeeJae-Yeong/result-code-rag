# 결과코드 RAG 시스템

Hybrid Search 기반의 결과코드 검색 및 설명 시스템입니다.

> **🍎 Mac 사용자**: [MAC_SETUP.md](MAC_SETUP.md)를 참고하세요!

## 🚀 주요 기능

- **Hybrid Search**: 임베딩 벡터 + BM25 알고리즘 조합
- **PDF 업로드**: PDF 파일에서 결과코드 자동 추출
- **엑셀 붙여넣기**: 엑셀 데이터를 복사하여 일괄 추가
- **다국어 지원**: 한국어, 영어, 숫자 혼합 텍스트 처리
- **실시간 검색**: Streamlit 기반 웹 인터페이스
- **신뢰도 점수**: 검색 결과의 신뢰도 제공
- **동적 가중치**: BM25와 임베딩 가중치 실시간 조정
- **자동 분류**: 설명 내용 기반 카테고리 자동 분류
- **데이터 관리**: 개별/카테고리별/전체 데이터 삭제 기능

## 📋 시스템 규칙

1. **정확한 코드 식별**: "결과코드 1", "결과코드 4007" 등 정확한 매핑
2. **Hybrid Search 우선**: 임베딩 코사인 유사도 + BM25 가중 평균
3. **점수 기반 정렬**: top_k_results는 항상 score 내림차순
4. **긴 설명 지원**: 문장 구조 유지하며 전체 설명 반환
5. **신뢰도 임계값**: confidence < 0.5 → "정의 없음"

## 🛠️ 설치 및 실행

### 1. 의존성 설치

```bash
pip install -r requirements.txt
```

### 2. 데이터 준비

`data/result_codes.json` 파일에 결과코드 데이터가 포함되어 있습니다.

### 3. 애플리케이션 실행

```bash
streamlit run app.py
```

### 4. 테스트 실행

```bash
python test_rag.py
```

## 📁 프로젝트 구조

```
new-multi-rag/
├── app.py                 # Streamlit 메인 애플리케이션
├── rag_system.py          # RAG 시스템 메인 로직
├── hybrid_search.py       # Hybrid Search 구현
├── pdf_parser.py          # PDF 파싱 및 결과코드 추출
├── config.py              # 설정 파일
├── test_rag.py            # 테스트 스크립트
├── requirements.txt       # 의존성 목록
├── data/
│   └── result_codes.json  # 결과코드 데이터
├── run.bat                # Windows 실행 스크립트
├── run.sh                 # Linux/Mac 실행 스크립트
└── README.md              # 프로젝트 문서
```

## 🔧 설정 옵션

`config.py`에서 다음 설정을 조정할 수 있습니다:

- `EMBEDDING_MODEL`: 사용할 임베딩 모델
- `BM25_WEIGHT`: BM25 가중치 (0.5~0.7 권장)
- `EMBEDDING_WEIGHT`: 임베딩 가중치
- `TOP_K_RESULTS`: 반환할 상위 결과 수
- `CONFIDENCE_THRESHOLD`: 신뢰도 임계값

## 📊 사용 예시

### 기본 검색

```python
from rag_system import RAGSystem

rag = RAGSystem()
result = rag.process_query("결과코드 4007")

print(f"코드: {result['code']}")
print(f"설명: {result['description']}")
print(f"신뢰도: {result['confidence']}")
```

### 상세 검색

```python
# 상위 10개 결과 반환
detailed_results = rag.get_detailed_results("결과코드 4007", 10)

for result in detailed_results:
    print(f"코드: {result['code']}")
    print(f"설명: {result['description']}")
    print(f"점수: {result['score']}")
```

## 📄 PDF 업로드 기능

### 지원되는 PDF 형식
- `결과코드 4007: 설명`
- `코드 4007: 설명`
- `에러코드 4007: 설명`
- `4007: 설명`
- `4007 - 설명`

### PDF 업로드 과정
1. **파일 선택**: PDF 파일 업로드
2. **미리보기**: 추출될 결과코드 확인
3. **자동 분류**: 카테고리 자동 분류
4. **중복 처리**: 기존 코드와 중복 체크
5. **데이터 추가**: 신규 코드만 데이터베이스에 추가

## 📊 엑셀 붙여넣기 기능

### 지원되는 엑셀 형식
- **표준 형식**: `코드`, `설명`, `카테고리` 컬럼
- **간단한 형식**: `코드`, `설명` 컬럼만
- **다른 컬럼명**: `번호`, `내용`, `분류` 등 자동 인식

### 엑셀 붙여넣기 과정
1. **데이터 복사**: 엑셀에서 데이터 선택 후 복사 (Ctrl+C)
2. **붙여넣기**: 텍스트 영역에 붙여넣기 (Ctrl+V)
3. **미리보기**: 추출될 결과코드 확인
4. **자동 분류**: 카테고리 자동 분류
5. **중복 처리**: 기존 코드와 중복 체크
6. **데이터 추가**: 신규 코드만 데이터베이스에 추가

## 🗑️ 데이터 관리 기능

### 개별 코드 삭제
- 특정 결과코드를 선택하여 삭제
- 코드 정보 미리보기 제공

### 카테고리별 삭제
- 특정 카테고리의 모든 코드를 한 번에 삭제
- 카테고리별 코드 수 통계 제공

### 전체 데이터 삭제
- 모든 결과코드를 영구적으로 삭제
- 안전을 위한 확인 체크박스 제공

### 데이터 백업/복원
- `data/result_codes.json` 파일로 데이터 저장
- 파일 복사로 백업/복원 가능

## 🎯 검색 예시

| 입력 | 출력 |
|------|------|
| "결과코드 1" | 코드: 1, 설명: 시스템 장애, 신뢰도: 0.92 |
| "결과코드 4007" | 코드: 4007, 설명: 서비스 요청한 클라이언트가 permission이 없는 경우..., 신뢰도: 0.88 |
| "결과코드 9999" | 코드: 9999, 설명: 해당 코드에 대한 정의가 없습니다., 신뢰도: 0.0 |

## 🔍 Hybrid Search 알고리즘

1. **쿼리 전처리**: 짧은 쿼리 확장 ("결과코드 4007" → "결과코드 4007 설명")
2. **BM25 점수 계산**: 키워드 기반 검색 점수
3. **임베딩 유사도**: 코사인 유사도 계산
4. **가중 평균**: `α × BM25 + (1-α) × 임베딩`
5. **정렬 및 반환**: 점수 내림차순 정렬

## 📈 성능 최적화

- **토큰화**: 한국어, 영어, 숫자 혼합 텍스트 처리
- **정규화**: 점수 범위 0-1로 정규화
- **캐싱**: 임베딩 벡터 사전 계산
- **배치 처리**: 여러 쿼리 동시 처리

## 🚨 주의사항

1. 첫 실행 시 임베딩 모델 다운로드로 시간이 소요될 수 있습니다.
2. 대용량 데이터의 경우 메모리 사용량을 고려해야 합니다.
3. 가중치 조정은 검색 성능에 큰 영향을 미칩니다.

## 📝 라이선스

MIT License
